#define WIFI_SSID "TP--Link"
#define WIFI_PASS "89508240145"
#define GOR1 2
#define GOR2 1
#define BOT_TOKEN "5710052332:AAFSjCW2vZW-nWMcd0GljNuNl3EHzd49_lc"
#define DATPOL 4
#define CHAT_ID "941712200"
char auth[] = "gk-47W3AoXa0ej2-HVK9vKgHty3BPqdW";
char ssid[] = "TP--Link";
char pass[] = "89508240145";

#include <WiFi.h>

#include <FastBot.h>


FastBot bot(BOT_TOKEN);


unsigned long currentMillis = 0;
unsigned long polive1 = 0, polive2 = 0;
unsigned long otchet1 = 0, otchet2 = 0;
unsigned long tmr = 1000000000000000, rab = 0, rabk = 1000000000;
boolean con = false;
int menuID = 0;
byte depth = 0;
boolean dat = true;
boolean gor_1 = false;
boolean gor_2 = false;
boolean con1 = false;
boolean con2 = false;



void setup() {

  start();
  Serial.begin(115200);
  pinMode(GOR1, OUTPUT);
  pinMode(GOR2, OUTPUT);
  bot.setChatID(CHAT_ID);
  bot.attach(newMsg);
  String menu1 = F("Water \t Get time \t Water for datchic \n Settings");
  bot.inlineMenu("Главная", menu1);

  menuID = bot.lastBotMsg();
}

void newMsg(FB_msg& msg) {
  if (msg.text == "/start") {
    String menu1 = F("Water \t Get time \t Water for datchic \n Settings");
    bot.inlineMenu("Главная", menu1);
    depth = 0;
    menuID = bot.lastBotMsg();
  }
  if (msg.data == "Water") {
    if (gor_1 == true && gor_2 == true) {
      String menu10 = F("Water first plant \t Water second plant \t Water first and second plant \n Back");
      bot.inlineMenu("Главная", menu10);
      depth = 1;
    }
    else if (gor_1 == true) {
      String menu1 = F("Water \t Get time \t Water for datchic \n Settings");
      bot.inlineMenu("Главная", menu1);
      depth = 0;
      currentMillis = millis();
      rabk = 10000;
      polive1 = currentMillis;
      digitalWrite(GOR1, 1);
      bot.sendMessage("За работу", CHAT_ID);
      con1 = true;
    }
    else {
      String menu1 = F("Water \t Get time \t Water for datchic \n Settings");
      bot.inlineMenu("Главная", menu1);
      depth = 0;
      currentMillis = millis();
      rabk = 10000;
      polive2 = currentMillis;
      digitalWrite(GOR2, 1);
      bot.sendMessage("За работу", CHAT_ID);
      con2 = true;
    }
  }
  if (msg.data == "Water first plant") {
    String menu1 = F("Water \t Get time \t Water for datchic \n Settings");
    bot.inlineMenu("Главная", menu1);
    depth = 0;
    currentMillis = millis();
    rabk = 10000;
    polive1 = currentMillis;
    digitalWrite(GOR1, 1);
    bot.sendMessage("За работу", CHAT_ID);
    con1 = true;
  }
  if (msg.data == "Water second plant"){
    String menu1 = F("Water \t Get time \t Water for datchic \n Settings");
    bot.inlineMenu("Главная", menu1);
    depth = 0;
    currentMillis = millis();
    rabk = 10000;
    polive2 = currentMillis;
    digitalWrite(GOR2, 1);
    bot.sendMessage("За работу", CHAT_ID);
    con2 = true;
  }
  if (msg.data == "Water first and second plant"){
    String menu1 = F("Water \t Get time \t Water for datchic \n Settings");
    bot.inlineMenu("Главная", menu1);
    depth = 0;
    currentMillis = millis();
    rabk = 10000;
    polive1 = currentMillis;
    digitalWrite(GOR1, 1);
    con1 = true;
    polive2 = currentMillis;
    digitalWrite(GOR2, 1);
    bot.sendMessage("За работу", CHAT_ID);
    con2 = true;
  }
  if (msg.data == "Water for datchic") {
    dat = true;
  }
  if (msg.data == "Get time") {
    String menu3 = F("10 second \t 2 minutes \t 8 hour \t 16 hour  \n Back");
    bot.editMenu(menuID, menu3);
    depth = 1;
  }
  if (msg.data == "10 second") {
    String menu1 = F("Water \t Get time \t Water for datchic \n Settings");
    bot.editMenu(menuID, menu1);
    tmr = 10000;
    depth = 0;
  }
  if (msg.data == "2 minutes") {
    String menu1 = F("Water \t Get time \t Water for datchic \n Settings");
    bot.editMenu(menuID, menu1);
    tmr = 60000;
    depth = 0;
  }
  if (msg.data == "8 hour") {
    String menu1 = F("Water \t Get time \t Water for datchic \n Settings");
    bot.editMenu(menuID, menu1);
    tmr = 1000000000000000000;
    depth = 0;
  }
  if (msg.data == "16 hour") {
    String menu1 = F("Water \t Get time \t Water for datchic \n Settings");
    bot.editMenu(menuID, menu1);
    tmr = 1000000000000000000;
    depth = 0;
  }
  if (msg.data == "Settings") {
    String menu2 = F("Get or delete plant \t Power Modes \t Add Device \t Service Mode \t Offline Mode  \n Back");
    bot.editMenu(menuID, menu2);
    depth = 1;
  }
  if (msg.data == "Get or delete plant") {
    if (gor_1 == false && gor_2 == false) {
      String menu4 = F("Get first plant \t Get second plant \t Get first and second plant \n Back");
      bot.editMenu(menuID, menu4);
      depth = 1;
    }
    else if (gor_1 == true && gor_2 == true) {
      String menu5 = F("Delete first plant \t Delete second plant \t Delete first and second plant \n Back");
      bot.editMenu(menuID, menu5);
      depth = 1;
    }
    else if (gor_1 == true && gor_2 == false) {
      String menu6 = F("Delete first plant \t Get second plant \n Back");
      bot.editMenu(menuID, menu6);
      depth = 1;
    }
    else {
      String menu7 = F("Get first plant \t Delete second plant \n Back");
      bot.editMenu(menuID, menu7);
      depth = 1;
    }
  }
  if (msg.data == "Get first plant") {
    gor_1 = true;
    String menu1 = F("Water \t Get time \t Water for datchic \n Settings");
    bot.editMenu(menuID, menu1);
    depth = 0;
  }
  if (msg.data == "Get second plant") {
    gor_2 = true;
    String menu1 = F("Water \t Get time \t Water for datchic \n Settings");
    bot.editMenu(menuID, menu1);
    depth = 0;
  }
  if (msg.data == "Delete first plant") {
    gor_1 = false;
    String menu1 = F("Water \t Get time \t Water for datchic \n Settings");
    bot.editMenu(menuID, menu1);
    depth = 0;
  }
  if (msg.data == "Delete second plant") {
    gor_2 = false;
    String menu1 = F("Water \t Get time \t Water for datchic \n Settings");
    bot.editMenu(menuID, menu1);
    depth = 0;
  }
  if (msg.data == "Delete first and second plant") {
    gor_1 = false;
    gor_2 = false;
    String menu1 = F("Water \t Get time \t Water for datchic \n Settings");
    bot.editMenu(menuID, menu1);
    depth = 0;
  }
  if (msg.data == "Get first and second plant") {
    gor_2 = true;
    gor_1 = true;
    String menu1 = F("Water \t Get time \t Water for datchic \n Settings");
    bot.editMenu(menuID, menu1);
    depth = 0;
  }
  if (msg.data == "Back" && depth == 1) {
    String menu1 = F("Water \t Get time \t Water for datchic \n Settings");
    bot.editMenu(menuID, menu1);
    depth = 0;
  }
}

void loop() {
  bot.tick();
  currentMillis = millis();
  if (currentMillis - otchet1 >= tmr && con1 == false) {
    rabk = 15000;
    polive1 = currentMillis;
    digitalWrite(GOR1, 1);
  }
  if (currentMillis - otchet2 >= tmr && con2 == false) {
    rabk = 15000;
    polive2 = currentMillis;
    digitalWrite(GOR2, 1);
  }
  if (currentMillis - polive1 >= rabk && con1 == true) {
    otchet1 = currentMillis;
    digitalWrite(GOR1, 0);
  }
  if (currentMillis - polive2 >= rabk && con2 == true) {
    otchet2 = currentMillis;
    digitalWrite(GOR2, 0);
  }
}
void start() {
  delay(2000);
  Serial.begin(115200);
  Serial.println();
  WiFi.begin(WIFI_SSID, WIFI_PASS);
  while (WiFi.status() != WL_CONNECTED) {

    if (millis() > 150000) ESP.restart();
  }
  Serial.println("Connected");
}
